---
title: "Diversity project actual analyses I swear"
layout: "post"
tags: "diversity"
output: html_document
editor_options: 
  chunk_output_type: console
---

We will finally analyse this data properly. 
```{r setup, include=F}
knitr::opts_knit$set(root.dir="~/OneDrive - St Vincent's Institute/Documents/RNA\ Diversity/", echo=T)
# But we also have to do this manually because R studio is stupid: 
setwd(knitr::opts_knit$get("root.dir"))
library(ggplot2)
library(data.table)
library(plyr)
library(reshape)
library(tidyverse)
library(patchwork)
library(ggalluvial)
library(RColorBrewer)
library(ggrepel)
library(viridis)
library(thematic)
library(scales)

options(device = "quartz")

allSRAFinal <- readRDS("20240901_allSRAFinal.rds")
```

After discussion with Amanda, we'll be using the strictestRace/Geography assignments, see `06_revisiting_population_terms` for more context on what this means.

```{r plotting-prep-1}
# First we clean up the plotting labels:
allSRAFinal <- allSRAFinal %>% 
    mutate(strictestRace = gsub("or ", "or\n", strictestRace)) %>%
    mutate(strictestGeography = gsub("and ", "and\n", strictestGeography)) %>%
    mutate(strictestGeography = gsub("^Asia$", "Asia (NOS)", strictestGeography)) %>%
    mutate(strictestGeography = gsub("Subsaharan", "Sub-Saharan", strictestGeography)) %>%
    mutate(hispanic = gsub("^hispanic$", "Hispanic", hispanic)) %>%
    mutate(finalOrgan = gsub("^cancer$", "Cancer sample\n(NOS)", finalOrgan)) %>%
    mutate(finalSystem = gsub("^cancer$", "Cancer sample\n(NOS)", finalSystem)) %>%
    as.data.frame()

# For moving columns to upper case, because I forgot... 
firstup <- function(x) {
  substr(x, 1, 1) <- toupper(substr(x, 1, 1))
  x
}

allSRAFinal$finalDisease <- firstup(allSRAFinal$finalDisease)
allSRAFinal$finalOrgan <- firstup(allSRAFinal$finalOrgan)
allSRAFinal$finalSystem <- firstup(allSRAFinal$finalSystem)

# Hispanic label trumps any other label
allSRAFinal$backupRace <- allSRAFinal$strictestRace
allSRAFinal$backupHispanic <- allSRAFinal$hispanic
allSRAFinal <- allSRAFinal %>% mutate(hispanic = na_if(hispanic, "non.hispanic"))
allSRAFinal$strictestRace <- coalesce(allSRAFinal$hispanic, allSRAFinal$strictestRace)
allSRAFinal$strictestRace <- factor(allSRAFinal$strictestRace)

# Now let's sort out some colour schemes... For Race we simply use Dark2 but we need to keep the mapping consistent, but for Geography we are following Alicia Martin and using a somewhat custom palette that doesn't follow anything standard, and then adding some new colours of our own; I opened a paper in Affinity and grabbed the html values and then added a couple for the new entries (Southeast Asia, Asia NOS):

allSRAFinal$strictestGeography <- factor(allSRAFinal$strictestGeography, levels = c("Sub-Saharan Africa", "North Africa and\nWestern Asia", "Europe", "South Asia", "Southeast Asia", "East Asia", "Asia (NOS)", "Oceania", "Americas", "Multiple", "Other"))

scale_fill_geography <- function(...){
    ggplot2:::manual_scale('fill',  
        values = setNames(c('#9C8DC3', '#F3D78A', '#DB6968', '#60BC55', '#BCCC45', '#4D97CD', '#04C3C8', '#C69C3A', '#F8984E', '#8B96AD', '#FBC9C4'), levels(allSRAFinal$strictestGeography)), 
    )
}

scale_color_geography <- function(...){
    ggplot2:::manual_scale('color',  
        values = setNames(c('#9C8DC3', '#F3D78A', '#DB6968', '#60BC55', '#BCCC45', '#4D97CD', '#04C3C8', '#C69C3A', '#F8984E', '#8B96AD', '#FBC9C4'), levels(allSRAFinal$strictestGeography)), 
    )
}

raceColours <- brewer.pal(8,"Set2") #8 because we don't plot NAs

scale_color_race <- function(...){
    ggplot2:::manual_scale('color', 
                           values = setNames(raceColours, levels(allSRAFinal$strictestRace)), 
    )
}

scale_fill_race <- function(...){
    ggplot2:::manual_scale('fill', 
        values = setNames(raceColours, levels(allSRAFinal$strictestRace)), 
    )
}

wberCols <- c(viridis::turbo(n = 7))
scale_fill_wber <- function(...){
    ggplot2:::manual_scale('fill', 
        values = setNames(wberCols, c("East Asia &\nPacific", "Europe &\nCentral Asia", "Latin America &\nCaribbean", "Middle East &\nNorth Africa", "North America", "South Asia", "Sub-Saharan Africa")), na.value = "grey50")
}


# We also define a couple of plot layouts:
long2Design <- "
  12
  12
"
wide2Design <- "
  11
  22
"

theme_set(theme_bw(base_size = 6))
theme_update(axis.text=element_text(size=7))
theme_update(legend.key.size = unit(12, 'pt'), #change legend key size
        legend.title = element_text(size=8), #change legend title font size
        legend.text = element_text(size=6),
        plot.title = element_text(size=8))
theme_update(plot.margin = unit(c(0, 0, 0, 0), "pt"))
```

We're also going to use some additional info from the World Bank, so let's add those columns in now:

```{r plotting-prep-2}
worldBank <- read.csv("World_Bank_Descriptors.csv")

# Some names need to be fixed, but others are more flexible? I'd rather have USA than United States.
allSRAFinal$finalCountry <- gsub("^UK$", "United Kingdom", allSRAFinal$finalCountry) 
allSRAFinal$finalCountry <- gsub("^Korea$", "South Korea", allSRAFinal$finalCountry)

allSRAFinal$worldBank <- worldBank[match(allSRAFinal$finalCountry, worldBank$Economy),]$Income.group
# allSRAFinal %>% count(finalCountry, worldBank)

# Missing countries are all high income, so we can set them to that manually now that we're happy with the names:
allSRAFinal <- allSRAFinal %>% 
  mutate(worldBank = if_else(is.na(worldBank), "High income", worldBank)) %>%
  mutate(worldBank = if_else(is.na(finalCountry), NA, worldBank ))

# And now the regions they define:
allSRAFinal$worldRegion <- worldBank[match(allSRAFinal$finalCountry, worldBank$Economy),]$Region
# allSRAFinal %>% count(finalCountry, worldRegion)

# Once again we gotta add some manually...
allSRAFinal <- allSRAFinal %>% 
  mutate(worldRegion = if_else(grepl("Russia|Slovakia", finalCountry), "Europe & Central Asia", worldRegion)) %>%
  mutate(worldRegion = if_else(grepl("South Korea|Taiwan", finalCountry), "East Asia & Pacific", worldRegion)) %>%
  mutate(worldRegion = if_else(grepl("USA", finalCountry), "North America", worldRegion)) %>%
  as.data.frame()

# And now we need to clean up some labels so we can plot them better. Good thing is, it's just an ampersand:
allSRAFinal$worldRegion <- gsub("& ", "&\n", allSRAFinal$worldRegion)
```

## 1. Who is being sequenced?

```{r plot-survey-level, out.width="100%"}
geographyProp <- allSRAFinal %>% drop_na(strictestGeography) %>% count(strictestGeography) %>% mutate(freq = n/sum(n))
raceProp <- allSRAFinal %>% drop_na(strictestRace) %>% count(strictestRace) %>% mutate(freq = n/sum(n))

geoPlot <- ggplot(geographyProp, aes(x = fct_inorder(strictestGeography), y = n, fill = strictestGeography)) +
  geom_bar(stat="identity") +
  ggtitle("Submitted descriptor\n(ancestral/geographic origin)") +
  xlab("") +
  ylab("Samples") +
  coord_flip() +
  scale_fill_geography() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(legend.position="none")

geographyProp
sum(geographyProp$n)

racePlot <- ggplot(raceProp, aes(x = fct_inorder(strictestRace), y = n, fill=strictestRace)) +
  geom_bar(stat="identity") +
  ggtitle("Submitted descriptor\n(US Census term)") +
  xlab("") +
  ylab("Samples") +
  coord_flip() +
  scale_fill_race() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(legend.position="none")

raceProp
sum(raceProp$n)

geoPlot + racePlot +
    plot_layout(design = long2Design)
ggsave("fig1_overall.pdf")

# And now with log transform on the axis:
geoPlot <- geoPlot +
  scale_y_continuous(trans='log10')
racePlot <- racePlot +
  scale_y_continuous(trans='log10')

geoPlot + racePlot +
    plot_layout(design = long2Design)
ggsave("fig1_overall_log10.pdf")

# There's 132 samples that do not have any info besides "Not Hispanic", which I think we should treat as NA, and therefore drop. The other option is to change them to race: Other and then move on with our lives. 
allSRAFinal %>% filter(is.na(allSRAFinal$strictestGeography) & is.na(allSRAFinal$strictestRace)) %>% count(ETHNICITY, RACE)
allSRAFinal <- allSRAFinal %>% filter(!is.na(allSRAFinal$strictestGeography) | !is.na(allSRAFinal$strictestRace))

nrow(allSRAFinal[!is.na(allSRAFinal$strictestGeography) | !is.na(allSRAFinal$strictestRace),])
dim(allSRAFinal)
```

All samples accounted for now, at last! 

So let's get a bit more granular, showing n samples per study:

```{r plot-survey-level-2, out.width="100%", echo=F}
sampleGeography <- allSRAFinal %>% count(SRA.Study, strictestGeography) %>% drop_na(strictestGeography)
sampleRace <- allSRAFinal %>% count(SRA.Study, strictestRace) %>% drop_na(strictestRace)
meltSampleGeography <- melt(sampleGeography)
meltSampleRace <- melt(sampleRace)

geobyStudy <- ggplot(meltSampleGeography, aes(x = strictestGeography, y=value,fill=strictestGeography)) +
  geom_boxplot(width=0.8, outlier.shape = NA) +
  geom_jitter(size=0.8, width=0.2, color="#333333") +
  ggtitle("Submitted descriptor\n(ancestral/geographic origin)") +
  xlab("") +
  ylab("Samples per study") +
  coord_flip() +
  scale_y_continuous(trans='log10') +
  scale_fill_geography() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(legend.position = "none")

racebyStudy <- ggplot(meltSampleRace, aes(x = strictestRace, y=value,fill=strictestRace)) +
  geom_boxplot(width=0.8, outlier.shape = NA) +
  geom_jitter(size=0.8, width=0.2, color="#333333") +
  ggtitle("Submitted descriptor\n(US Census term)") +
  xlab("") +
  ylab("Samples per study") +
  coord_flip() +
  scale_y_continuous(trans='log10') +
  scale_fill_race() +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(legend.position = "none")

geobyStudy + racebyStudy +
  plot_layout(design = long2Design) +
  plot_annotation(tag_levels = 'A') 
ggsave("fig2_by_study_boxplot.pdf", width=7, height=7)
ggsave("fig2_by_study_boxplot.png", width=7, height=7)

geobyStudy <- ggplot(meltSampleGeography, aes(x = strictestGeography, y=value,fill=strictestGeography)) +
  geom_boxplot(width=0.8, outlier.shape = NA) +
  geom_jitter(size=1.2, width=0.2, color="#333333") +
  ggtitle("Submitted descriptor\n(ancestral/geographic origin)") +
  xlab("") +
  ylab("Samples per study") +
  scale_y_continuous(trans='log10') +
  annotation_logticks(sides="l") +
  scale_fill_geography() +
  theme(axis.text.x = element_text(angle = 30, hjust=1)) +
  theme(legend.position = "none") +
  theme(axis.text=element_text(size=10))

racebyStudy <- ggplot(meltSampleRace, aes(x = strictestRace, y=value,fill=strictestRace)) +
  geom_boxplot(width=0.8, outlier.shape = NA) +
  geom_jitter(size=0.8, width=0.2, color="#333333") +
  ggtitle("Submitted descriptor\n(US Census term)") +
  xlab("") +
  ylab("Samples per study") +
  scale_y_continuous(trans='log10') +
  annotation_logticks(sides="l") +
  scale_fill_race() +
  theme(axis.text.x = element_text(angle = 30, hjust=1)) +
  theme(legend.position = "none") +
  theme(axis.text=element_text(size=10))

geobyStudy + racebyStudy +
  plot_layout(design = wide2Design) +
  plot_annotation(tag_levels = 'A') 
ggsave("fig2_by_study_boxplot_for_talk.pdf", width=7, height=6)
ggsave("fig2_by_study_boxplot_for_talk.png", width=7, height=6)

```

Let's get some meaningful statistics on this:

First we separate studies on the basis of whether they contain racial or geographic descriptors, but the hispanic usage introduces a new complexity... There's a bunch of studies that now straddle the two categories. Could shift them to race like we did before, but better to just leave them alone for now? I am overthinking.

```{r study-size-statistics}
geographyClean <- allSRAFinal %>% drop_na(strictestGeography) 
raceClean <- allSRAFinal %>% drop_na(strictestRace)

geoSRA <- unique(geographyClean$SRA.Study)
length(geoSRA)
raceSRA <- unique(raceClean$SRA.Study)
length(raceSRA)
length(intersect(geoSRA, raceSRA)) 

allSRAFinal %>% filter(grepl(paste(intersect(geoSRA, raceSRA), collapse="|"), SRA.Study)) %>%
  group_by(SRA.Study) %>%
  summarise(size = n(), studyJoint = n_distinct(SRA.Study)) 

allSRAFinal %>% filter(grepl(paste(intersect(geoSRA, raceSRA), collapse="|"), SRA.Study)) %>% nrow()

# Diversity by study:
geographyClean %>% group_by(SRA.Study) %>% 
  summarise(size = n(), studyGeo = n_distinct(strictestGeography)) %>%
  summarise(n = size, meanSize = mean(size), meanGeo = mean(studyGeo), maxSize = max(size), maxGeo = max(studyGeo), sdSize = sd(size), sdGeo = sd(studyGeo))

raceClean %>% group_by(SRA.Study) %>% 
  summarise(size = n(), studyRace = n_distinct(strictestRace)) %>%
  summarise(n = size, meanSize = mean(size), meanRace = mean(studyRace), maxSize = max(size), maxRace = max(studyRace), sdSize = sd(size), sdRace = sd(studyRace))

# By descriptor across all studies
geographyClean %>% group_by(SRA.Study) %>% count(strictestGeography) %>% group_by(strictestGeography) %>% 
  summarise(size = sum(n), studyGeo = n_distinct(SRA.Study), mean = mean(n), max = max(n), sd = sd(n)) 

raceClean %>% group_by(SRA.Study) %>% count(strictestRace) %>% group_by(strictestRace) %>% 
  summarise(size = sum(n), studyRace = n_distinct(SRA.Study), mean = mean(n), max = max(n), sd = sd(n)) 
```

## 2. And by who? Where is the sequencing happening? 

There are many ways to slice this, but some are harder to see than others, so here is the final best attempt...

```{r plot-clean-country, out.width="100%", echo=F}
geoByCountry <- allSRAFinal %>% drop_na(finalCountry, strictestGeography) %>% count(finalCountry, strictestGeography, worldRegion) %>% melt() %>% arrange(worldRegion) %>% 
ggplot(., aes(x = fct_inorder(finalCountry), y=value, fill = strictestGeography)) +
  geom_bar(stat = "identity") +
  ggtitle("Submitted descriptor\n(ancestral/geographic)") +
  xlab("SRA depositor country") +
  ylab("Number of samples") +
  coord_flip() +
  scale_fill_geography(name = "Population\nDescriptor") + # For some reason this isn't working for setting the name...
  guides(fill=guide_legend(title="", label.position="left")) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(legend.title.align = 1, legend.direction = "vertical", legend.justification = c(1,0), legend.position = c(1,0), legend.background=element_blank())

raceByCountry <- allSRAFinal %>% drop_na(finalCountry, strictestRace) %>% count(finalCountry, strictestRace, worldRegion) %>% melt() %>% arrange(worldRegion) %>% 
ggplot(., aes(x = fct_inorder(finalCountry), y=value, fill = strictestRace)) +
  geom_bar(stat = "identity") +
  ggtitle("Submitted descriptor\n(US Census term)") +
  # xlab("SRA depositor country") +
  xlab("") + # It's plotted side by side with the other one, so no need here, I think
  ylab("Number of samples") +
  coord_flip() +
  scale_fill_race(name="US Census\nTerm") +
  guides(fill=guide_legend(title="", label.position = "left")) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(legend.title.align = 1, legend.direction = "vertical", legend.justification = c(1,0), legend.position = c(1,0), legend.background=element_blank())

geoByCountry + raceByCountry +
    plot_layout(design = long2Design)
ggsave("fig2_by_country.pdf")

geoByRegion <- allSRAFinal %>% drop_na(worldRegion, strictestGeography) %>% count(worldRegion, strictestGeography) %>% melt() %>% arrange(worldRegion) %>% 
ggplot(., aes(x = fct_rev(fct_infreq(worldRegion)), y=value, fill = strictestGeography)) +
  geom_bar(stat = "identity") +
  ggtitle("Submitted descriptor\n(ancestral/geographic)") +
  xlab("SRA depositor Region") +
  ylab("Number of samples") +
  coord_flip() +
  scale_fill_geography(name = "Population\nDescriptor") + # For some reason this isn't working for setting the name...
  guides(fill=guide_legend(title="", label.position="left")) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(legend.title.align = 1, legend.direction = "vertical", legend.justification = c(1,0), legend.position = c(1,0), legend.background=element_blank())

raceByRegion <- allSRAFinal %>% drop_na(worldRegion, strictestRace) %>% count(worldRegion, strictestRace, worldRegion) %>% melt() %>% arrange(worldRegion) %>% 
ggplot(., aes(x = fct_rev(fct_infreq(worldRegion)), y=value, fill = strictestRace)) +
  geom_bar(stat = "identity") +
  ggtitle("Submitted descriptor\n(US Census term)") +
  # xlab("SRA depositor Region") +
  xlab("") + # It's plotted side by side with the other one, so no need here, I think
  ylab("Number of samples") +
  coord_flip() +
  scale_fill_race(name="US Census\nTerm") +
  guides(fill=guide_legend(title="", label.position = "left")) +
  theme(axis.text.x = element_text(angle = 45, hjust=1)) +
  theme(legend.title.align = 1, legend.direction = "vertical", legend.justification = c(1,0), legend.position = c(1,0), legend.background=element_blank())

geoByRegion + raceByRegion +
    plot_layout(design = long2Design) +
    plot_annotation(tag_levels = 'A')
ggsave("fig2_by_region.pdf", width=7, height=4)
ggsave("fig2_by_region.png", width=7, height=4)

studybyRegion <- allSRAFinal %>% count(SRA.Study, worldRegion) %>% drop_na(worldRegion) %>% 
  ggplot(., aes(x = worldRegion, y=n,fill=worldRegion)) +
    geom_boxplot(width=0.8, outlier.shape = NA) +
    geom_jitter(size=0.8, width=0.2, color="#333333") +
    ggtitle("Sample depositor location\n(WB Economic Region)") +
    xlab("") +
    ylab("Samples per study") +
    coord_flip() +
    scale_y_continuous(trans='log10') +
    scale_fill_wber() +
    theme(axis.text.x = element_text(angle = 45, hjust=1)) +
    theme(legend.position = "none")

studybyRegion
ggsave("fig2_by_study_by_region.pdf", height=5, width=5)
ggsave("fig2_by_study_by_region.png", height=5, width=5)

```

Some nice statistics about all of this:

```{r plot-clean-country-2, out.width="100%"}
# By study by world region:
geographyClean %>% group_by(worldRegion, SRA.Study) %>% 
  summarise(size = n(), studyGeo = n_distinct(strictestGeography)) %>%
  summarise(n = n(), meanSize = mean(size), meanGeo = mean(studyGeo), maxSize = max(size), maxGeo = max(studyGeo), sdSize = sd(size), sdGeo = sd(studyGeo))

raceClean %>% group_by(worldRegion, SRA.Study) %>% 
  summarise(size = n(), studyRace = n_distinct(strictestRace)) %>%
  summarise(n = n(), meanSize = mean(size), meanRace = mean(studyRace), maxSize = max(size), maxRace = max(studyRace), sdSize = sd(size), sdRace = sd(studyRace))

# By descriptor by economic region
geographyClean %>% group_by(SRA.Study, worldRegion) %>% count(strictestGeography) %>% group_by(worldRegion, strictestGeography) %>% 
  summarise(size = sum(n), studyGeo = n_distinct(SRA.Study), mean = mean(n), max = max(n), sd = sd(n)) %>%
  as.data.frame()

raceClean %>% group_by(SRA.Study, worldRegion) %>% count(strictestRace) %>% group_by(worldRegion, strictestRace) %>% 
  summarise(size = sum(n), studyRace = n_distinct(SRA.Study), mean = mean(n), max = max(n), sd = sd(n)) %>%
  as.data.frame()

allSRAFinal %>% filter(!is.na(worldBank)) %>% count(worldBank) %>% mutate(freq = n/sum(n)) %>% arrange(desc(freq))
allSRAFinal %>% filter(!is.na(finalCountry)) %>% count(finalCountry) %>% mutate(freq = n/sum(n)) %>% arrange(desc(freq))

allSRAFinal %>% filter(!is.na(strictestGeography)) %>% count(worldBank) %>% mutate(freq = n/sum(n)) %>% arrange(desc(freq))
allSRAFinal %>% filter(!is.na(strictestRace)) %>% count(worldBank) %>% mutate(freq = n/sum(n)) %>% arrange(desc(freq))

allSRAFinal %>% filter(!is.na(strictestGeography)) %>% count(finalCountry) %>% mutate(freq = n/sum(n)) %>% arrange(desc(freq))
allSRAFinal %>% filter(!is.na(strictestRace)) %>% count(finalCountry) %>% mutate(freq = n/sum(n)) %>% arrange(desc(freq))

allSRAFinal %>% filter(!is.na(strictestGeography)) %>% count(worldRegion) %>% mutate(freq = n/sum(n)) %>% arrange(desc(freq))
allSRAFinal %>% filter(!is.na(strictestRace)) %>% count(worldRegion) %>% mutate(freq = n/sum(n)) %>% arrange(desc(freq))
allSRAFinal %>% count(worldRegion) %>% mutate(freq = n/sum(n)) %>% arrange(desc(freq))

# And finally... are studies from certain regions bigger than others?
NAEurSizes <- allSRAFinal %>% filter(worldRegion == "North America" | worldRegion == "Europe") %>%
  count(SRA.Study)

restWorldSizes <- allSRAFinal %>% filter(worldRegion != "North America" & worldRegion != "Europe") %>%
  count(SRA.Study)

t.test(restWorldSizes$n, NAEurSizes$n)

allStudySizes <- allSRAFinal %>% group_by(SRA.Study) %>% 
  summarise(sampleSize = n(), region = worldRegion) %>% 
  distinct()

lm(sampleSize ~ region, data = allStudySizes)
anova(lm(sampleSize ~ region, data = allStudySizes))


# Note that there's an issue here - although we filtered for studies with more than 10 entries, not all of those will have 10 samples with descriptors, which explains why these numbers are smaller. So long as we are consistent across the two datasets, it should be ok. 

```

Maybe worth considering some alluvial plots? At the single country level they're very messy, however, so what about at the World Bank region level?

```{r plot-clean-country-3, out.width="100%"}
allSRAFinal %>% count(strictestGeography, worldRegion) %>% drop_na(c(strictestGeography, worldRegion)) %>%
  ggplot(data = .,
         aes(axis1 = worldRegion, axis2 = strictestGeography, y = n)) +
    scale_x_discrete(limits = c("SRA Depositor\nRegion", "Population\nDescriptor"), expand = c(.2, .05)) +
    geom_alluvium(aes(fill = strictestGeography)) +
    scale_fill_geography(name="Population\nDescriptor") +
    geom_stratum(width=1/3) +
    ylab("Samples") +
    geom_text_repel(stat = "stratum", aes(label = after_stat(stratum)), size = 2.5, direction = "y", nudge_x = .5) +
    theme_minimal(base_size = 6) +
    theme(legend.position = "none")

allSRAFinal %>% count(strictestRace, worldRegion) %>% drop_na(c(strictestRace, worldRegion)) %>%
  ggplot(data = .,
         aes(axis1 = worldRegion, axis2 = strictestRace, y = n)) +
    scale_x_discrete(limits = c("SRA Depositor\nRegion", "US Census Racial Term"), expand = c(.2, .05)) +
    geom_alluvium(aes(fill = strictestRace)) +
    scale_fill_race(name="US Census\nTerm)") +
    geom_stratum(width=1/3) +
    ylab("Samples") +
    # geom_text(stat = "stratum", aes(label = after_stat(stratum))) +
    geom_text_repel(stat = "stratum", aes(label = after_stat(stratum)), size = 2.5, direction = "y", nudge_x = .5) +
    theme_minimal(base_size = 6) +
    theme(legend.position = "none")

### And finally... does it have any kind of description??
allSRAFinal <- allSRAFinal %>% 
  mutate(hasDescriptor = if_else(is.na(strictestRace), "Geographic", "Racial"))

# Easiest to see with a boxplot?
descriptorUsePlot <- ggplot(allSRAFinal, aes(x = finalCountry, fill = hasDescriptor)) +
  geom_bar(position = "fill") +
  ggtitle("") +
  xlab("SRA depositor country") +
  ylab("Proportion of samples") +
  coord_fixed(ratio=6) +
  guides(fill=guide_legend(title="Descriptor\ntype")) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

descriptorUsePlot
ggsave("fig2_descriptor_use.pdf")

descriptorUseRegionPlot <- ggplot(allSRAFinal, aes(x = worldRegion, fill = hasDescriptor)) +
  geom_bar(position = "fill") +
  ggtitle("") +
  xlab("SRA depositor region") +
  ylab("Proportion of samples") +
  guides(fill=guide_legend(title="Descriptor\ntype")) +
  theme(axis.text.x = element_text(angle = 45, hjust=1))

descriptorUseRegionPlot
ggsave("fig2_descriptor_use_region_plot.pdf")

descriptorUseRegionAlluvial <- allSRAFinal %>% count(hasDescriptor, worldRegion) %>% drop_na(c(hasDescriptor, worldRegion)) %>%
  ggplot(data = .,
         aes(axis1 = worldRegion, axis2 = hasDescriptor, y = n)) +
    scale_x_discrete(limits = c("SRA Depositor\nRegion", "Population\nDescriptor"), expand = c(.2, .05)) +
    geom_alluvium(aes(fill = hasDescriptor)) +
    geom_stratum(width=1/3) +
    ylab("Samples") +
    geom_text_repel(stat = "stratum", aes(label = after_stat(stratum)), size = 2.5, direction = "y", nudge_x = .5) +
    theme_minimal(base_size = 6) +
    theme(legend.position = "none")

descriptorUseRegionAlluvial
ggsave("fig2_descriptor_use_region_alluvial.pdf")

```

And now, some statistics from the figures above:
  
```{r clean-country-stats}
allSRAFinal %>% count(finalCountry, hasDescriptor) %>% 
  group_by(finalCountry) %>%
  mutate(percent = 100 * n/sum(n)) %>%
  ungroup %>%
  as.data.frame()
                
allSRAFinal %>% filter(!grepl('USA', finalCountry)) %>% 
  count(hasDescriptor) %>% 
  mutate(freq = n/sum(n))

allSRAFinal %>% filter(grepl('USA', finalCountry)) %>% 
  count(hasDescriptor) %>% 
  mutate(freq = n/sum(n))

descriptorChi <- full_join((allSRAFinal %>% filter(!grepl('USA', finalCountry)) %>% 
  count(hasDescriptor) %>% 
  mutate(freq = n/sum(n))),
  (allSRAFinal %>% filter(grepl('USA', finalCountry)) %>% 
  count(hasDescriptor) %>% 
  mutate(freq = n/sum(n))), by = "hasDescriptor", suffix = c("noUSA", "USA"))

chisq.test(descriptorChi[,c(2,4)])

allSRAFinal %>% count(hasDescriptor) %>% 
  mutate(freq = n/sum(n))

# We also want to know the mean sample size of studies in the USA vs those not in the USA, for funsies
usaSizes <- allSRAFinal %>% filter(grepl('USA', finalCountry)) %>%
  group_by(SRA.Study) %>%
  summarise(n = n())
mean(usaSizes$n)

nousaSizes <- allSRAFinal %>% filter(!grepl('USA', finalCountry)) %>%
  group_by(SRA.Study) %>%
  summarise(n = n())
mean(nousaSizes$n)

t.test(usaSizes$n, nousaSizes$n)
```

## 3. What tissues are they sequencing?

As above, we start by looking simply at the country/region where sequencing is happening. A quick straw poll suggested finalOrgan was more interpretable than finalSystem, so I'm sticking with organ. Will have to work out how to do plots of disease and tissue with all the missing values, but I think we're getting closer

```{r first-pass-tissue, out.width="100%"}
# First we focus on population descriptors:
geographySummary <- allSRAFinal %>% count(strictestGeography, finalCountry, worldRegion, finalOrgan, finalDisease)
raceSummary <- allSRAFinal %>% count(strictestRace, finalCountry, worldRegion, finalOrgan, finalDisease)

geoOrgan <- geographySummary %>% group_by(finalOrgan, strictestGeography) %>% summarise(value = sum(n)) %>% distinct() %>% drop_na(c(finalOrgan, strictestGeography)) %>% as.data.frame %>%
# geoOrgan <- meltGeography %>% drop_na(c(finalOrgan, strictestGeography)) %>%
  ggplot(., aes(x = fct_rev(finalOrgan), y = value, fill = strictestGeography)) +
  geom_bar(stat="identity") +
  xlab("") +
  ylab("Samples") +
  coord_flip() +
  scale_fill_geography(name="Population\nDescriptor") +
  guides(fill=guide_legend(title="", label.position="left", ncol=1)) +
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=0.5)) +
  theme(legend.title = element_blank(), legend.direction = "vertical", legend.justification = c(1,0), legend.position = c(1,0), legend.background=element_blank())

raceOrgan <- raceSummary %>% group_by(finalOrgan, strictestRace) %>% summarise(value = sum(n)) %>% distinct() %>% drop_na(c(finalOrgan, strictestRace)) %>% as.data.frame %>%
# raceOrgan <- meltRace %>% drop_na(c(finalOrgan, strictestRace)) %>%
  ggplot(., aes(x = fct_rev(finalOrgan), y = value, fill = strictestRace)) +
  geom_bar(stat="identity") +
  xlab("Sampled tissue") +
  ylab("Samples") +
  coord_flip() +
  scale_fill_race(name="US Census\nTerm)") +
  guides(fill=guide_legend(title="", label.position="left")) +
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=0.5)) +
  theme(legend.title = element_blank(), legend.direction = "vertical", legend.justification = c(1,0), legend.position = c(1,0), legend.background=element_blank())

geoOrgan + raceOrgan +
  plot_layout(design=long2Design) +
  plot_annotation(tag_levels = 'A') 
ggsave("fig3_organ_by_descriptor.pdf", height=8, width=6)
ggsave("fig3_organ_by_descriptor.png", height=8, width=6)

# And now filtering to only those tissues with more than 50 observations

geoOrganSlim <- geographySummary %>% group_by(finalOrgan, strictestGeography) %>% summarise(value = sum(n)) %>% distinct() %>% drop_na(c(finalOrgan, strictestGeography)) %>% group_by(finalOrgan) %>% filter(sum(value) > 99) %>% as.data.frame %>%
# geoOrgan <- meltGeography %>% drop_na(c(finalOrgan, strictestGeography)) %>%
  ggplot(., aes(x = finalOrgan, y = value, fill = strictestGeography)) +
  geom_bar(stat="identity") +
  xlab(NULL) +
  ylab("Samples") +
  # coord_flip() +
  scale_fill_geography(name="Population\nDescriptor") +
  guides(fill=guide_legend(title="", label.position="left", ncol=3)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1)) +
  theme(legend.title = element_blank(), legend.direction = "vertical", legend.justification = c(1,1), legend.position = c(1,1), legend.background=element_blank())

raceOrganSlim <- raceSummary %>% group_by(finalOrgan, strictestRace) %>% summarise(value = sum(n)) %>% distinct() %>% drop_na(c(finalOrgan, strictestRace)) %>% group_by(finalOrgan) %>% filter(sum(value) > 99) %>% as.data.frame %>%
# raceOrgan <- meltRace %>% drop_na(c(finalOrgan, strictestRace)) %>%
  ggplot(., aes(x = finalOrgan, y = value, fill = strictestRace)) +
  geom_bar(stat="identity") +
  xlab(NULL) +
  ylab("Samples") +
  # coord_flip() +
  scale_fill_race(name="US Census\nTerm)") +
  guides(fill=guide_legend(title="", label.position="left", ncol=2)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1)) +
  theme(legend.title = element_blank(), legend.direction = "vertical", legend.justification = c(1,1), legend.position = c(1,1), legend.background=element_blank())

geoOrganSlim + raceOrganSlim +
  plot_layout(design=wide2Design) +
  plot_annotation(tag_levels = 'A') 
ggsave("fig3_organ_by_descriptor_slim.pdf", width = 7, height = 4.5)
ggsave("fig3_organ_by_descriptor_slim.png", width = 7, height = 4.5)

# Some statistics: The percentage of samples that each tissue accounts for, and how many descriptors are associated:
allSRAFinal %>% count(hasDescriptor, finalOrgan) %>% group_by(hasDescriptor) %>% summarise(finalOrgan = finalOrgan, n = n, proportion = n/sum(n)) %>% as.data.frame

allSRAFinal %>% count(finalOrgan, strictestGeography) %>% drop_na(strictestGeography) %>% group_by(finalOrgan) %>% summarise(geoGroups = length(finalOrgan)) %>% arrange(desc(geoGroups)) %>% as.data.frame
  
allSRAFinal %>% count(finalOrgan, strictestRace) %>% drop_na(strictestRace) %>% group_by(finalOrgan) %>% summarise(raceGroups = length(finalOrgan)) %>% arrange(desc(raceGroups)) %>% as.data.frame

# And how many tissues is each descriptor associated with?
allSRAFinal %>% drop_na(strictestGeography, finalOrgan) %>% count(finalOrgan) 
allSRAFinal %>% drop_na(strictestRace, finalOrgan) %>% count(finalOrgan) 

23/28
36/37

allSRAFinal %>% count(finalOrgan, strictestGeography) %>% drop_na(strictestGeography) %>% group_by(strictestGeography) %>% summarise(geoGroups = length(strictestGeography)) %>% arrange(desc(geoGroups)) %>% as.data.frame
  
allSRAFinal %>% count(finalOrgan, strictestRace) %>% drop_na(strictestRace) %>% group_by(strictestRace) %>% summarise(raceGroups = length(strictestRace)) %>% arrange(desc(raceGroups)) %>% as.data.frame

# And now some alluvial plots, for funsies and supplementary data:
allSRAFinal %>% drop_na(strictestGeography) %>% count(worldRegion)
allSRAFinal %>% drop_na(strictestRace) %>% count(worldRegion)

geoTissueFacet <- geographySummary %>% group_by(finalOrgan, strictestGeography, worldRegion) %>% summarise(value = sum(n)) %>% distinct() %>% drop_na(c(finalOrgan, strictestGeography, worldRegion)) %>% as.data.frame %>%
  ggplot(., aes(x = finalOrgan, y = value, fill = strictestGeography)) +
  geom_bar(stat="identity") +
  ggtitle("Samples with geographic/ancestry labels deposited in:") +
  xlab("Sampled tissue") +
  ylab("Samples") +
  scale_fill_geography(name="Population\nDescriptor") +
  guides(fill=guide_legend(title="", nrow=2)) +
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=0.5)) +
  theme(legend.title = element_blank(), legend.position="bottom", legend.direction="horizontal") +
  theme(strip.background = element_blank()) +
  facet_wrap(~worldRegion, ncol=1, scales="free_y")

geoTissueFacet
ggsave("fig3_organ_by_geography_faceted.pdf", width=6, height=9)
ggsave("fig3_organ_by_geography_faceted.png", width=6, height=9)

raceTissueFacet <- raceSummary %>% group_by(finalOrgan, strictestRace, worldRegion) %>% summarise(value = sum(n)) %>% distinct() %>% drop_na(c(finalOrgan, strictestRace, worldRegion)) %>% as.data.frame %>%
  ggplot(., aes(x = finalOrgan, y = value, fill = strictestRace)) +
  geom_bar(stat="identity") +
  ggtitle("Samples with US Census labels deposited in:") +
  xlab("Sampled tissue") +
  ylab("Samples") +
  scale_fill_race(name="US Census\nTerm)") +
  guides(fill=guide_legend(title="")) +
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=0.5)) +
  theme(legend.title = element_blank(), legend.position="bottom", legend.direction="horizontal") +
  theme(strip.background = element_blank()) +
  facet_wrap(~worldRegion, ncol=1, scales="free_y")

raceTissueFacet
ggsave("fig3_organ_by_race_faceted.pdf", width=6, height=9)
ggsave("fig3_organ_by_race_faceted.png", width=6, height=9)

```

And now we should ask, since these proportions look different, are there differences? Is having a given descriptor associated with higher likelihood or something or something else being sequenced?

We can do this at the `hasDescriptor` level (racial vs geographic), at the `finalCountry` level and at the `worldRegion` level, although we also might want to consider the actual descriptors

But first, an easier question: Is blood really more diverse than anything else? 

```{r first-pass-tissue-2, out.width="100%"}
bloodPropGeo <- allSRAFinal %>% filter(grepl("Blood", finalOrgan) & !is.na(strictestGeography)) %>% 
  count(strictestGeography) %>% 
  mutate(freq = n/sum(n))

nobloodPropGeo <- allSRAFinal %>% filter(!grepl("Blood", finalOrgan) & !is.na(strictestGeography)) %>% 
  count(strictestGeography) %>% 
  mutate(freq = n/sum(n))

bloodPropRace <- allSRAFinal %>% filter(grepl("Blood", finalOrgan) & !is.na(strictestRace)) %>% 
  count(strictestRace) %>% 
  mutate(freq = n/sum(n))
  
nobloodPropRace <- allSRAFinal %>% filter(!grepl("Blood", finalOrgan) & !is.na(strictestRace)) %>% 
  count(strictestRace) %>% 
  mutate(freq = n/sum(n))

geoBlood <- full_join(bloodPropGeo, nobloodPropGeo, by="strictestGeography", suffix=c("Blood", "NoBlood")) %>%
  full_join(., geographyProp, by="strictestGeography") %>%
  mutate(across(where(is.numeric), ~replace(., is.na(.), 0)))

raceBlood <- full_join(bloodPropRace, nobloodPropRace, by="strictestRace", suffix=c("Blood", "NoBlood")) %>%
  full_join(., raceProp, by="strictestRace") %>%
  mutate(across(where(is.numeric), ~replace(., is.na(.), 0)))

chisq.test(geoBlood[,c(2,6)])
chisq.test(raceBlood[,c(2,6)])

# Both are significant but blood is clearly a lot more diverse
geoBlood
raceBlood
```

```{r first-pass-tissue-3, out.width="100%"}
allPropGeo <- allSRAFinal %>% filter(!is.na(worldRegion)) %>% 
  group_by(worldRegion) %>%
  count(finalOrgan) %>% 
  as.data.frame() 

# Not very promising...
anova(lm(n ~ finalOrgan + worldRegion, data=allPropGeo))

allPropGeo <- allPropGeo %>% 
  cast(., worldRegion ~ finalOrgan) %>%
  mutate(across(where(is.numeric), ~replace(., is.na(.), 0)))

# Boring, uninterpretable, cannot be bothered to go any further. Keep it descriptive
chisq.test(allPropGeo[,2:ncol(allPropGeo)])

```

## 3.5. What about diseases? Are there associations between place and type?

```{r first-pass-disease-1, out.width="100%"}
geoDisease <- geographySummary %>% group_by(finalDisease, strictestGeography) %>% summarise(value = sum(n)) %>% distinct() %>% drop_na(c(finalDisease, strictestGeography)) %>% as.data.frame %>%
# geoDisease <- meltGeography %>% drop_na(c(finalDisease, strictestGeography)) %>%
  ggplot(., aes(x = fct_rev(finalDisease), y = value, fill = strictestGeography)) +
  geom_bar(stat="identity") +
  xlab("") +
  ylab("Samples") +
  coord_flip() +
  scale_fill_geography(name="Population\nDescriptor") +
  guides(fill=guide_legend(title="", label.position="left", ncol=1)) +
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=0.5)) +
  theme(legend.title = element_blank(), legend.direction = "vertical", legend.justification = c(1,0), legend.position = c(1,0), legend.background=element_blank())

raceDisease <- raceSummary %>% group_by(finalDisease, strictestRace) %>% summarise(value = sum(n)) %>% distinct() %>% drop_na(c(finalDisease, strictestRace)) %>% as.data.frame %>%
# raceDisease <- meltRace %>% drop_na(c(finalDisease, strictestRace)) %>%
  ggplot(., aes(x = fct_rev(finalDisease), y = value, fill = strictestRace)) +
  geom_bar(stat="identity") +
  xlab("Sampled tissue") +
  ylab("Samples") +
  coord_flip() +
  scale_fill_race(name="US Census\nTerm)") +
  guides(fill=guide_legend(title="", label.position="left")) +
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=0.5)) +
  theme(legend.title = element_blank(), legend.direction = "vertical", legend.justification = c(1,0), legend.position = c(1,0), legend.background=element_blank())

geoDisease + raceDisease +
  plot_layout(design=long2Design) +
  plot_annotation(tag_levels = 'A') 
ggsave("fig4_disease_by_descriptor.pdf", height=8, width=6)
ggsave("fig4_disease_by_descriptor.png", height=8, width=6)

# And now filtering to only those tissues with more than 50 observations

geoDiseaseSlim <- geographySummary %>% group_by(finalDisease, strictestGeography) %>% summarise(value = sum(n)) %>% distinct() %>% drop_na(c(finalDisease, strictestGeography)) %>% group_by(finalDisease) %>% filter(sum(value) > 9) %>% as.data.frame %>%
# geoDisease <- meltGeography %>% drop_na(c(finalDisease, strictestGeography)) %>%
  ggplot(., aes(x = finalDisease, y = value, fill = strictestGeography)) +
  geom_bar(stat="identity") +
  xlab(NULL) +
  ylab("Samples") +
  # coord_flip() +
  scale_fill_geography(name="Population\nDescriptor") +
  guides(fill=guide_legend(title="", label.position="left", ncol=3)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1)) +
  theme(legend.title = element_blank(), legend.direction = "vertical", legend.justification = c(1,1), legend.position = c(1,1), legend.background=element_blank())

raceDiseaseSlim <- raceSummary %>% group_by(finalDisease, strictestRace) %>% summarise(value = sum(n)) %>% distinct() %>% drop_na(c(finalDisease, strictestRace)) %>% group_by(finalDisease) %>% filter(sum(value) > 9) %>% as.data.frame %>%
# raceDisease <- meltRace %>% drop_na(c(finalDisease, strictestRace)) %>%
  ggplot(., aes(x = finalDisease, y = value, fill = strictestRace)) +
  geom_bar(stat="identity") +
  xlab(NULL) +
  ylab("Samples") +
  # coord_flip() +
  scale_fill_race(name="US Census\nTerm)") +
  guides(fill=guide_legend(title="", label.position="left", ncol=2)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1)) +
  theme(legend.title = element_blank(), legend.direction = "vertical", legend.justification = c(1,1), legend.position = c(1,1), legend.background=element_blank())

geoDiseaseSlim + raceDiseaseSlim +
  plot_layout(design=wide2Design) +
  plot_annotation(tag_levels = 'A') 
ggsave("fig4_disease_by_descriptor_slim.pdf", width = 7, height = 4.5)
ggsave("fig4_disease_by_descriptor_slim.png", width = 7, height = 4.5)

# Some statistics: The percentage of samples that each tissue accounts for, and how many descriptors are associated:
allSRAFinal %>% count(hasDescriptor, finalDisease) %>% group_by(hasDescriptor) %>% summarise(finalDisease = finalDisease, n = n, proportion = n/sum(n)) %>% as.data.frame

allSRAFinal %>% count(worldRegion, finalDisease) %>% group_by(worldRegion) %>% summarise(finalDisease = finalDisease, n = n, proportion = n/sum(n)) %>% arrange(finalDisease) %>% as.data.frame

allSRAFinal %>% count(worldRegion, finalDisease) %>% group_by(finalDisease) %>% summarise(worldRegion = worldRegion, n = n, proportion = n/sum(n)) %>% arrange(finalDisease) %>% as.data.frame

allSRAFinal %>% count(finalDisease, strictestGeography) %>% drop_na(strictestGeography) %>% group_by(finalDisease) %>% summarise(geoGroups = length(finalDisease)) %>% arrange(desc(geoGroups)) %>% as.data.frame
  
allSRAFinal %>% count(finalDisease, strictestRace) %>% drop_na(strictestRace) %>% group_by(finalDisease) %>% summarise(raceGroups = length(finalDisease)) %>% arrange(desc(raceGroups)) %>% as.data.frame

# And how many tissues is each descriptor associated with?
allSRAFinal %>% drop_na(strictestGeography, finalDisease) %>% count(finalDisease) 
allSRAFinal %>% drop_na(strictestRace, finalDisease) %>% count(finalDisease) 

allSRAFinal %>% count(finalDisease, strictestGeography) %>% drop_na(strictestGeography) %>% group_by(strictestGeography) %>% summarise(geoGroups = length(strictestGeography)) %>% arrange(desc(geoGroups)) %>% as.data.frame
  
allSRAFinal %>% count(finalDisease, strictestRace) %>% drop_na(strictestRace) %>% group_by(strictestRace) %>% summarise(raceGroups = length(strictestRace)) %>% arrange(desc(raceGroups)) %>% as.data.frame

# And now some alluvial plots, for funsies and supplementary data:
geoDiseaseFacet <- geographySummary %>% group_by(finalDisease, strictestGeography, worldRegion) %>% summarise(value = sum(n)) %>% distinct() %>% drop_na(c(finalDisease, strictestGeography, worldRegion)) %>% as.data.frame %>%
  ggplot(., aes(x = finalDisease, y = value, fill = strictestGeography)) +
  geom_bar(stat="identity") +
  ggtitle("Samples with geographic/ancestry labels deposited in:") +
  xlab("Sampled tissue") +
  ylab("Samples") +
  scale_fill_geography(name="Population\nDescriptor") +
  guides(fill=guide_legend(title="", nrow=2)) +
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1)) +
  theme(legend.title = element_blank(), legend.position="bottom", legend.direction="horizontal") +
  theme(strip.background = element_blank()) +
  facet_wrap(~worldRegion, ncol=1, scales="free_y")

geoDiseaseFacet
ggsave("fig4_disease_by_geography_faceted.pdf", width=6, height=9)
ggsave("fig4_disease_by_geography_faceted.png", width=6, height=9)

raceDiseaseFacet <- raceSummary %>% group_by(finalDisease, strictestRace, worldRegion) %>% summarise(value = sum(n)) %>% distinct() %>% drop_na(c(finalDisease, strictestRace, worldRegion)) %>% as.data.frame %>%
  ggplot(., aes(x = finalDisease, y = value, fill = strictestRace)) +
  geom_bar(stat="identity") +
  ggtitle("Samples with US Census labels deposited in:") +
  xlab("Sampled tissue") +
  ylab("Samples") +
  scale_fill_race(name="US Census\nTerm)") +
  guides(fill=guide_legend(title="")) +
  theme(axis.text.x = element_text(angle = 45, hjust=1, vjust=1)) +
  theme(legend.title = element_blank(), legend.position="bottom", legend.direction="horizontal") +
  theme(strip.background = element_blank()) +
  facet_wrap(~worldRegion, ncol=1, scales="free_y")

raceDiseaseFacet
ggsave("fig4_disease_by_race_faceted.pdf", width=6, height=9)
ggsave("fig4_disease_by_race_faceted.png", width=6, height=9)

```

## 4. Attempting to look at some of the relationships between classes:

What we really want to get to is the relationship between tissue and disease, because we think it might be interesting.

```{r combine-all-levels-1, out.width="100%"}
# Let's collapse tissues with under 100 observations and diseases with under 10 into "Other"
geoTissuesToKeep <- allSRAFinal %>% drop_na(strictestGeography) %>% count(finalOrgan) %>% filter(n >= 100)
raceTissuesToKeep <- allSRAFinal %>% drop_na(strictestRace) %>% count(finalOrgan) %>% filter(n >= 100)

geoDiseasesToKeep <- allSRAFinal %>% drop_na(strictestGeography) %>% count(finalDisease) %>% filter(n >= 10)
raceDiseasesToKeep <- allSRAFinal %>% drop_na(strictestRace) %>% count(finalDisease) %>% filter(n >= 10)

geoDisAlluvial <- allSRAFinal %>% drop_na(c(strictestGeography, worldRegion, finalOrgan, finalDisease)) %>% count(worldRegion, strictestGeography, finalOrgan, finalDisease) %>%
filter(grepl(paste(geoTissuesToKeep$finalOrgan, collapse="|"), finalOrgan)) %>%  
filter(grepl(paste(geoDiseasesToKeep$finalDisease, collapse="|"), finalDisease)) %>%  
    ggplot(data = .,
       aes(axis1 = worldRegion, axis2 = finalOrgan, axis3 = finalDisease, y = n)) +
  scale_x_discrete(limits = c("SRA Submitter\nWBER", "Disease class", "Tissue sequenced"), expand = c(.2, .05)) +
  geom_alluvium(aes(fill = strictestGeography)) +
  scale_fill_geography() +
  geom_stratum(width=1/4) +
  ylab("Samples") +
  # geom_text(stat = "stratum", aes(label = after_stat(stratum)), size=2.5) +
  geom_text_repel(stat = "stratum", aes(label = after_stat(stratum)), size = 2.5, direction = "y", nudge_x = .5) +
  theme_minimal(base_size = 6) +
  guides(fill=guide_legend(title="Descriptor", nrow=2)) +
  theme(legend.title = element_blank(), legend.position="bottom", legend.direction="horizontal")

raceDisAlluvial <- allSRAFinal %>% drop_na(c(strictestRace, worldRegion, finalOrgan, finalDisease)) %>% count(worldRegion, strictestRace, finalOrgan, finalDisease) %>% 
  filter(grepl(paste(raceTissuesToKeep$finalOrgan, collapse="|"), finalOrgan)) %>%  
  filter(grepl(paste(raceDiseasesToKeep$finalDisease, collapse="|"), finalDisease)) %>%  
ggplot(data = .,
       aes(axis1 = worldRegion, axis2 = finalOrgan, axis3 = finalDisease, y = n)) +
  scale_x_discrete(limits = c("SRA Submitter\nWBER", "Tissue sequenced", "Disease class"), expand = c(.2, .05)) +
  geom_alluvium(aes(fill = strictestRace)) +
  scale_fill_race() +
  geom_stratum(width=1/4) +
  ylab("Samples") +
  # geom_text(stat = "stratum", aes(label = after_stat(stratum)), size=2.5) +
  geom_text_repel(stat = "stratum", aes(label = after_stat(stratum)), size = 2.5, direction = "y", nudge_x = .5) +
  theme_minimal(base_size = 6) +
  guides(fill=guide_legend(title="Descriptor", nrow=2)) +
  theme(legend.title = element_blank(), legend.position="bottom", legend.direction="horizontal")

geoDisAlluvial + raceDisAlluvial +
  plot_layout(design=long2Design) +
  plot_annotation(tag_levels = 'A') 
ggsave("fig4_organ_disease_alluvial.pdf", width = 7, height = 7)

geoDisAlluvial <- allSRAFinal %>% drop_na(c(strictestGeography, worldRegion, finalOrgan, finalDisease)) %>% count(worldRegion, strictestGeography, finalOrgan, finalDisease) %>%
    ggplot(data = .,
       aes(axis1 = worldRegion, axis2 = finalOrgan, axis3 = finalDisease, y = n)) +
  scale_x_discrete(limits = c("SRA Submitter\nWBER", "Disease class", "Tissue sequenced"), expand = c(.2, .05)) +
  geom_alluvium(aes(fill = strictestGeography)) +
  scale_fill_geography() +
  geom_stratum(width=1/4) +
  ylab("Samples") +
  # geom_text(stat = "stratum", aes(label = after_stat(stratum)), size=2.5) +
  geom_text_repel(stat = "stratum", aes(label = after_stat(stratum)), size = 2.5, direction = "y", nudge_x = .5) +
  theme_minimal(base_size = 6) +
  guides(fill=guide_legend(title="Descriptor", nrow=2)) +
  theme(legend.title = element_blank(), legend.position="bottom", legend.direction="horizontal")

geoDisAlluvial
ggsave("fig4_organ_disease_geo_alluvial_full.pdf", width = 7, height = 7)
ggsave("fig4_organ_disease_geo_alluvial_full.png", width = 7, height = 7)


raceDisAlluvial <- allSRAFinal %>% drop_na(c(strictestRace, worldRegion, finalOrgan, finalDisease)) %>% count(worldRegion, strictestRace, finalOrgan, finalDisease) %>% 
ggplot(data = .,
       aes(axis1 = worldRegion, axis2 = finalOrgan, axis3 = finalDisease, y = n)) +
  scale_x_discrete(limits = c("SRA Submitter\nWBER", "Tissue sequenced", "Disease class"), expand = c(.2, .05)) +
  geom_alluvium(aes(fill = strictestRace)) +
  scale_fill_race() +
  geom_stratum(width=1/4) +
  ylab("Samples") +
  # geom_text(stat = "stratum", aes(label = after_stat(stratum)), size=2.5) +
  geom_text_repel(stat = "stratum", aes(label = after_stat(stratum)), size = 2.5, direction = "y", nudge_x = .5) +
  theme_minimal(base_size = 6) +
  guides(fill=guide_legend(title="Descriptor", nrow=2)) +
  theme(legend.title = element_blank(), legend.position="bottom", legend.direction="horizontal")

raceDisAlluvial 
ggsave("fig4_organ_disease_race_alluvial_full.pdf", width = 7, height = 7)
ggsave("fig4_organ_disease_race_alluvial_full.png", width = 7, height = 7)

geoDisAlluvial + raceDisAlluvial +
  plot_layout(design=long2Design) +
  plot_annotation(tag_levels = 'A') 
ggsave("fig4_organ_disease_alluvial_full.pdf", width = 7, height = 7)
```

And finally... the numbers that underlie these plots, because otherwise I'll go crazy trying to tabulate things:

```{r combine-all-levels-2, out.width="100%"}
allSRAFinal <- allSRAFinal %>% 
  mutate(hasDisease = if_else(is.na(finalDisease), "No", "Yes"))

# Who has disease info?
allSRAFinal %>% count(hasDisease) %>% mutate(freq = n/sum(n))
allSRAFinal %>% drop_na(strictestGeography) %>% count(hasDisease) %>% mutate(freq = n/sum(n))
allSRAFinal %>% drop_na(strictestRace) %>% count(hasDisease) %>% mutate(freq = n/sum(n))

# Some of these could work better as plots:
ggplot(allSRAFinal, aes(x = finalOrgan, fill = hasDisease)) +
  geom_bar(position = "fill") +
  ggtitle("") +
  xlab("Sequenced tissue") +
  ylab("Proportion of samples") +
  coord_fixed(ratio=6) +
  guides(fill=guide_legend(title="Disease info?")) +
  theme(axis.text.x = element_text(angle = 90, hjust=1, vjust=0.5))

allSRAFinal %>% drop_na(finalOrgan) %>% count(hasDisease) %>% mutate(freq = n/sum(n))
allSRAFinal %>% drop_na(finalOrgan) %>% count(finalOrgan, hasDisease) %>% group_by(finalOrgan) %>% mutate(freq = n/sum(n)) %>% ungroup() %>% as.data.frame()

# Increasing levels of disease and geography granularity:
allSRAFinal %>% drop_na(strictestGeography) %>% count(strictestGeography, hasDisease) %>% mutate(freq = n/sum(n))
allSRAFinal %>% drop_na(strictestRace) %>% count(strictestRace, hasDisease) %>% mutate(freq = n/sum(n))
allSRAFinal %>% drop_na(worldRegion) %>% count(worldRegion, hasDisease) %>% mutate(freq = n/sum(n))

allSRAFinal %>% drop_na(strictestGeography, finalDisease) %>% count(strictestGeography, finalDisease) %>% mutate(freq = n/sum(n))
allSRAFinal %>% drop_na(strictestRace, finalDisease) %>% count(strictestRace, finalDisease) %>% mutate(freq = n/sum(n))
allSRAFinal %>% drop_na(worldRegion, finalDisease) %>% count(worldRegion, finalDisease) %>% mutate(freq = n/sum(n)) 

allSRAFinal %>% drop_na(strictestGeography, finalDisease) %>% count(finalDisease, strictestGeography) %>% mutate(freq = n/sum(n)) %>% group_by(finalDisease) %>% mutate(diseaseFreq = n/sum(n)) %>% ungroup() %>% as.data.frame()
allSRAFinal %>% drop_na(strictestRace, finalDisease) %>% count(finalDisease, strictestRace) %>% mutate(freq = n/sum(n)) %>% group_by(finalDisease) %>% mutate(diseaseFreq = n/sum(n)) %>% ungroup() %>% as.data.frame()
allSRAFinal %>% drop_na(worldRegion, finalDisease) %>% count(finalDisease, worldRegion) %>% mutate(freq = n/sum(n)) %>% group_by(finalDisease) %>% mutate(diseaseFreq = n/sum(n)) %>% ungroup() %>% as.data.frame()

# And here comes the awfulness... disease by tissue and the rest:
allSRAFinal %>% drop_na(strictestGeography, finalDisease) %>% count(finalDisease, finalOrgan, strictestGeography) %>% mutate(freq = n/sum(n)) %>% group_by(finalDisease) %>% mutate(diseaseFreq = n/sum(n)) %>% ungroup() %>% as.data.frame()
allSRAFinal %>% drop_na(strictestRace, finalDisease) %>% count(finalDisease, finalOrgan, strictestRace) %>% mutate(freq = n/sum(n)) %>% group_by(finalDisease) %>% mutate(diseaseFreq = n/sum(n)) %>% ungroup() %>% as.data.frame()
allSRAFinal %>% drop_na(worldRegion, finalDisease) %>% count(finalDisease, finalOrgan, worldRegion) %>% mutate(freq = n/sum(n)) %>% group_by(finalDisease) %>% mutate(diseaseFreq = n/sum(n)) %>% ungroup() %>% as.data.frame()
```

And then we write the file out, for the joint plotting adventures...

```{r allSRAOut}
saveRDS(allSRAFinal, file="20240901_allSRAFinal_for_plotting.rds")
```
